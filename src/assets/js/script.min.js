let isUpdate,updateId;const notesContainer=document.querySelector("main"),popupBox=document.querySelector(".popup-box"),connectBox=document.querySelector(".connect-box"),creerBox=document.querySelector(".creer-box"),titleTag=popupBox.querySelector("#title"),descTag=popupBox.querySelector("#content"),couleurs=document.querySelectorAll(".couleurs span"),darken=document.querySelector(".darken"),switchElement=document.querySelector(".switch"),notes=JSON.parse(localStorage.getItem("local_notes")||"[]"),showNotes=async()=>{notes&&(document.querySelectorAll(".note").forEach(e=>e.remove()),notes.sort((e,t)=>new Date(t.date)-new Date(e.date)).forEach((e,t)=>{let n=e.couleur,r=e.hidden,o=e.title,s=replaceAllStart(e.description),l=new showdown.Converter({tasklists:!0,smoothLivePreview:!0,extensions:[taskListEnablerExtension]}),c=document.createElement("div"),a=document.createElement("div"),i=document.createElement("p"),d=document.createElement("span"),p=document.createElement("div"),u=document.createElement("i"),h=document.createElement("span"),m=document.createElement("i"),y=document.createElement("i"),f=document.createElement("i"),L=document.createElement("i");c.setAttribute("id","note"+t),c.classList.add("note",n),c.setAttribute("tabindex","0"),a.classList.add("details"),i.classList.add("title"),i.textContent=o,r?d.innerHTML="*****":d.innerHTML=replaceAllEnd(l.makeHtml(s)),a.appendChild(i),a.appendChild(d),c.appendChild(a),p.classList.add("bottom-content"),u.classList.add("fa-solid","fa-calendar-days"),u.setAttribute("title","Date (GMT)"),h.textContent=e.date,m.classList.add("fa-solid","fa-pen"),m.onclick=()=>{updateNote(t,o,s,n,r)},m.setAttribute("tabindex","0"),r||(y.classList.add("fa-solid","fa-clipboard"),y.onclick=()=>{copy(replaceAllStart(s))},y.setAttribute("tabindex","0"),L.classList.add("fa-solid","fa-expand"),L.onclick=()=>{toggleFullscreen(t)},L.setAttribute("tabindex","0")),f.classList.add("fa-solid","fa-trash-can"),f.onclick=()=>{deleteNote(t,o)},f.setAttribute("tabindex","0"),p.appendChild(u),p.appendChild(h),p.appendChild(m),r||p.appendChild(y),p.appendChild(f),r||p.appendChild(L),c.appendChild(p),notesContainer.appendChild(c)}))};function toggleFullscreen(e){let t=document.querySelector("#note"+e);t.classList.toggle("fullscreen"),darken.classList.toggle("show"),document.body.classList.toggle("noscroll")}function updateNote(e,t,n,r,o){let s=document.querySelectorAll(".note"),l=replaceAllStart(n);s.forEach(e=>{e.classList.remove("fullscreen")}),darken.classList.remove("show"),document.body.classList.add("noscroll"),updateId=e,isUpdate=!0,document.querySelector(".icon").click(),titleTag.value=t,descTag.value=l,couleurs.forEach(e=>{e.classList.contains(r)?e.classList.add("selectionne"):e.classList.remove("selectionne")}),o?document.getElementById("checkHidden").checked=!0:document.getElementById("checkHidden").checked=!1,descTag.focus()}function taskListEnablerExtension(){return[{type:"output",regex:/<input type="checkbox"?/g,replace:'<input type="checkbox"'}]}function replaceAllStart(e){return e.replaceAll("<br /><br />","\n\n").replaceAll("<br />","\n")}function replaceAllEnd(e){return e.replaceAll("\n\n","<br /><br />").replaceAll("\n","<br />")}function copy(e){let t=replaceAllStart(e),n=document.getElementById("copyNotification");navigator.clipboard.writeText(t),n.classList.add("show"),setTimeout(()=>{n.classList.remove("show")},2e3)}function deleteNote(e,t){if(window.location.pathname.endsWith("en.php")){if(confirm(`Do you really want to delete the note ${t}?`)){notes.splice(e,1),localStorage.setItem("local_notes",JSON.stringify(notes)),darken.classList.remove("show"),document.body.classList.remove("noscroll"),showNotes();return}}else if(confirm(`Voulez-vous vraiment supprimer la note ${t} ?`)){notes.splice(e,1),localStorage.setItem("local_notes",JSON.stringify(notes)),darken.classList.remove("show"),document.body.classList.remove("noscroll"),showNotes();return}}document.addEventListener("keydown",e=>{"Enter"===e.key&&document.activeElement.classList.contains("fa-clipboard")&&document.activeElement.click()}),document.addEventListener("keydown",e=>{"Enter"===e.key&&document.activeElement.classList.contains("fa-trash-can")&&document.activeElement.click()}),document.addEventListener("keydown",e=>{"Enter"===e.key&&document.activeElement.classList.contains("fa-pen")&&document.activeElement.click()}),document.addEventListener("keydown",e=>{"Enter"===e.key&&document.activeElement.classList.contains("fa-expand")&&document.activeElement.click()}),document.querySelectorAll(".seconnecter").forEach(e=>{e.addEventListener("click",()=>{connectBox.classList.add("show"),document.body.classList.add("noscroll"),document.querySelector("#nomConnect").focus()}),e.addEventListener("keydown",t=>{"Enter"===t.key&&e.click()})}),switchElement.addEventListener("keydown",e=>{if("Enter"===e.key){let t=switchElement.querySelector('input[type="checkbox"]');t.checked=!t.checked,switchElement.classList.toggle("checked")}}),document.querySelectorAll(".creercompte").forEach(e=>{e.addEventListener("click",()=>{connectBox.classList.remove("show"),creerBox.classList.add("show"),document.body.classList.add("noscroll"),document.querySelector("#nomCreer").focus()}),e.addEventListener("keydown",t=>{"Enter"===t.key&&e.click()})}),document.querySelector("#submitCreer").addEventListener("click",async()=>{let e=document.querySelector("#nomCreer").value.trim(),t=document.querySelector("#mdpCreer").value,n=document.querySelector("#mdpCreerValid").value;if(!e||!t||!n)return;if(!/^[a-zA-ZÀ-ÿ -]+$/.test(e)){if(window.location.pathname.endsWith("en.php")){alert("The name can only contain letters...");return}alert("Le nom ne peut contenir que des lettres...");return}if(e.length<4){if(window.location.pathname.endsWith("en.php")){alert("Name too short (<4)...");return}alert("Nom trop court (<4)...");return}if(t.length<6){if(window.location.pathname.endsWith("en.php")){alert("Password too weak (<6)...");return}alert("Mot de passe trop faible (<6)...");return}if(/^[0-9]+$/.test(t)){if(window.location.pathname.endsWith("en.php")){alert("Password too weak (only numbers)...");return}alert("Le mot de passe ne peut pas contenir que des chiffres...");return}if(/^[a-zA-Z]+$/.test(t)){if(window.location.pathname.endsWith("en.php")){alert("Password too weak (only letters)...");return}alert("Le mot de passe ne peut pas contenir que des lettres...");return}if(t!==n){if(window.location.pathname.endsWith("en.php")){alert("Passwords do not match...");return}alert("Les mots de passe ne correspondent pas...");return}if(e===t){if(window.location.pathname.endsWith("en.php")){alert("The password must be different from the username...");return}alert("Le mot de passe doit \xeatre diff\xe9rent du nom...");return}let r=encodeURIComponent(e),o=encodeURIComponent(t);try{let s=await fetch("/projets/notes/assets/php/formCreer.php",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:"nomCreer="+r+"&mdpCreer="+o+"&csrf_token_creer="+document.getElementById("csrf_token_creer").value});if(s.ok){window.location.pathname.endsWith("en.php")?alert("Account created! Please log in."):alert("Compte cr\xe9\xe9 ! Veuillez vous connecter."),creerBox.classList.remove("show"),document.body.classList.remove("noscroll"),document.querySelectorAll("form").forEach(e=>e.reset());return}if(window.location.pathname.endsWith("en.php")){alert("User already exists...");return}alert("Utilisateur d\xe9j\xe0 existant...");return}catch(l){if(window.location.pathname.endsWith("en.php")){alert("An error occurred while creating the account...");return}alert("Une erreur est survenue lors de la cr\xe9ation du compte...");return}}),document.querySelector("#submitSeConnecter").addEventListener("click",async()=>{let e=document.querySelector("#nomConnect").value.trim(),t=document.querySelector("#mdpConnect").value;if(!e||!t)return;if(!/^[a-zA-ZÀ-ÿ -]+$/.test(e)){if(window.location.pathname.endsWith("en.php")){alert("The name can only contain letters...");return}alert("Le nom ne peut contenir que des lettres...");return}let n=encodeURIComponent(e),r=encodeURIComponent(t);fetch("/projets/notes/assets/php/formConnect.php",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:"nomConnect="+n+"&mdpConnect="+r+"&csrf_token_connect="+document.getElementById("csrf_token_connect").value}).then(e=>{if(200===e.status)location.reload();else{if(window.location.pathname.endsWith("en.php")){alert("Wrong credentials..."),document.querySelector("#mdpConnect").value="";let t=document.querySelector("#submitSeConnecter");t.disabled=!0;let n=10;t.textContent=`Sign in (${n})`;let r=setInterval(()=>{n--,t.textContent=`Sign in (${n})`},1e3);setTimeout(()=>{clearInterval(r),t.disabled=!1,t.textContent="Sign in"},11e3);return}{alert("Mauvais identifiants..."),document.querySelector("#mdpConnect").value="";let o=document.querySelector("#submitSeConnecter");o.disabled=!0;let s=10;o.textContent=`Se connecter (${s})`;let l=setInterval(()=>{s--,o.textContent=`Se connecter (${s})`},1e3);setTimeout(()=>{clearInterval(l),o.disabled=!1,o.textContent="Se connecter"},11e3);return}}})}),document.querySelectorAll(".icon").forEach(e=>{e.addEventListener("click",()=>{popupBox.classList.add("show"),document.body.classList.add("noscroll"),document.querySelector("#title").focus()}),e.addEventListener("keydown",t=>{"Enter"===t.key&&e.click()})}),couleurs.forEach((e,t)=>{e.addEventListener("click",e=>{couleurs.forEach(e=>{e.classList.remove("selectionne")}),e.target.classList.add("selectionne")}),e.addEventListener("keydown",t=>{"Enter"===t.key&&e.click()}),0===t&&e.classList.add("selectionne")}),document.querySelector("#submitNote").addEventListener("click",()=>{let e=document.querySelector(".couleurs span.selectionne"),t=e.classList[0],n=titleTag.value.trim().replaceAll(/'/g,"‘").replaceAll(/\\/g,"/").replaceAll(/"/g,"‘‘"),r=descTag.value.replaceAll(/'/g,"‘").replaceAll(/\\/g,"/").replaceAll(/"/g,"‘‘"),o=document.getElementById("checkHidden").checked;if(!n||!r||r.length>2e3)return;let s={couleur:t,title:n,description:r,date:new Date().toISOString().slice(0,19).replace("T"," "),hidden:o};isUpdate?(isUpdate=!1,notes[updateId]=s):notes.push(s),localStorage.setItem("local_notes",JSON.stringify(notes)),document.querySelectorAll("form").forEach(e=>e.reset()),popupBox.classList.remove("show"),document.body.classList.remove("noscroll"),showNotes()}),document.querySelectorAll("form").forEach(e=>{e.addEventListener("submit",e=>{e.preventDefault()})}),document.querySelectorAll("header i").forEach(e=>{e.addEventListener("click",()=>{isUpdate=!1,document.querySelectorAll("form").forEach(e=>e.reset()),popupBox.classList.remove("show"),connectBox.classList.remove("show"),creerBox.classList.remove("show"),document.body.classList.remove("noscroll"),darken.classList.remove("show")}),e.addEventListener("keydown",t=>{"Enter"===t.key&&e.click()})}),document.querySelector("#search-input").addEventListener("keyup",()=>{let e=document.querySelector("#search-input").value.trim().toLowerCase();document.querySelectorAll(".note").forEach(t=>{let n=t.querySelector(".note p").innerText.toLowerCase();n.includes(e)?t.style.display="flex":t.style.display="none"})}),document.addEventListener("keydown",e=>{e.ctrlKey&&"k"===e.key&&(e.preventDefault(),document.querySelector("#search-input").focus())}),document.addEventListener("DOMContentLoaded",()=>{showNotes(),"serviceWorker"in navigator&&navigator.serviceWorker.register("/projets/notes/sw.js")});
