let isUpdate,updateId;const notesContainer=document.querySelector("main"),popupBoxConnect=document.querySelector(".connect-popup-box"),popupBoxGestion=document.querySelector(".gestion-popup-box"),titleTagConnect=popupBoxConnect.querySelector("#titleConnect"),descTagConnect=popupBoxConnect.querySelector("textarea"),darken=document.querySelector(".darken"),switchElement=document.querySelector(".switch"),couleurs=document.querySelectorAll(".couleurs span"),showNotesConnect=async()=>{let e=await fetch("/projets/notes/assets/php/getNotes.php",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/x-www-form-urlencoded"}}),t=await e.json(),o=new showdown.Converter({tasklists:!0,smoothLivePreview:!0,extensions:[taskListEnablerExtension]}),n=t.map(e=>{let{id:t,title:n,couleur:s,desc:l,date:r,hidden:a}=e;l=!1==l?"":l;let c=replaceAllStart(l),i=0===a?`<div id="note${t}" tabindex="0" class="note ${s}"><div class="details"><p class="title">${n}</p><span>${replaceAllEnd(o.makeHtml(c))}</span></div><div class="bottom-content"><i title="Date (GMT)" class="fa-solid fa-calendar-days"></i><span>${r}</span><i class="fa-solid fa-pen" tabindex="0" onclick="updateNoteConnect(${t},'${n}','${replaceAllEnd(c)}','${s}','${a}')"></i><i class="fa-solid fa-clipboard" tabindex="0" onclick="copy('${replaceAllEnd(c)}')"></i><i class="fa-solid fa-trash-can" tabindex="0" onclick="deleteNoteConnect(${t},'${n}')"></i><i class="fa-solid fa-expand" tabindex="0" onclick="toggleFullscreen(${t})"></i></div></div>`:`<div id="note${t}" tabindex="0" class="note ${s}"><div class="details"><p class="title">${n}</p><span>*****</span></div><div class="bottom-content"><i title="Date (GMT)" class="fa-solid fa-calendar-days"></i><span>${r}</span><i class="fa-solid fa-pen" tabindex="0" onclick="updateNoteConnect(${t},'${n}','${replaceAllEnd(c)}','${s}','${a}')"></i><i class="fa-solid fa-trash-can" tabindex="0" onclick="deleteNoteConnect(${t},'${n}')"></i></div></div>`;return i}).join("");notesContainer.insertAdjacentHTML("beforeend",n)},fetchDelete=async e=>{fetch("/projets/notes/assets/php/deleteNote.php",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:"noteId="+encodeURIComponent(e)}).then(e=>{e.ok&&(document.querySelectorAll(".note").forEach(e=>{e.remove()}),darken.classList.remove("show"),document.body.classList.remove("noscroll"),showNotesConnect())})},deleteAccount=async()=>{fetch("/projets/notes/assets/php/deleteAccount.php",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(e=>{200===e.status?location.reload():window.location.pathname.endsWith("en.php")?alert("An error occurred while deleting your account..."):alert("Une erreur est survenue lors de la suppression de votre compte...")})},fetchLogout=async()=>{fetch("/projets/notes/assets/php/logout.php",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(e=>{200===e.status&&location.reload()})};function replaceAllStart(e){return e.replaceAll("<br /><br />","\n\n").replaceAll("<br />","\n")}function replaceAllEnd(e){return e.replaceAll("\n\n","<br /><br />").replaceAll("\n","<br />")}function toggleFullscreen(e){let t=document.querySelector("#note"+e);t.classList.toggle("fullscreen"),darken.classList.toggle("show"),document.body.classList.toggle("noscroll")}function updateNoteConnect(e,t,o,n,s){let l=document.querySelectorAll(".note");l.forEach(e=>{e.classList.remove("fullscreen")}),darken.classList.remove("show"),document.body.classList.add("noscroll"),isUpdate=!0,document.querySelector(".iconConnect").click(),document.querySelector("#idNoteInput").value=e,titleTagConnect.value=t,descTagConnect.value=replaceAllStart(o),couleurs.forEach(e=>{e.classList.contains(n)?e.classList.add("selectionne"):e.classList.remove("selectionne")}),0==s?document.getElementById("checkHidden").checked=!1:document.getElementById("checkHidden").checked=!0,descTagConnect.focus()}function copy(e){let t=replaceAllStart(e),o=document.getElementById("copyNotification");navigator.clipboard.writeText(t),o.classList.add("show"),setTimeout(()=>{o.classList.remove("show")},2e3)}function deleteNoteConnect(e,t){window.location.pathname.endsWith("en.php")?confirm(`Do you really want to delete the note ${t}?`)&&fetchDelete(e):confirm(`Voulez-vous vraiment supprimer la note ${t} ?`)&&fetchDelete(e)}function taskListEnablerExtension(){return[{type:"output",regex:/<input type="checkbox"?/g,replace:'<input type="checkbox"'}]}document.addEventListener("keydown",e=>{"Enter"===e.key&&document.activeElement.classList.contains("fa-clipboard")&&document.activeElement.click()}),document.addEventListener("keydown",e=>{"Enter"===e.key&&document.activeElement.classList.contains("fa-trash-can")&&document.activeElement.click()}),document.addEventListener("keydown",e=>{"Enter"===e.key&&document.activeElement.classList.contains("fa-pen")&&document.activeElement.click()}),document.addEventListener("keydown",e=>{"Enter"===e.key&&document.activeElement.classList.contains("fa-expand")&&document.activeElement.click()}),switchElement.addEventListener("keydown",e=>{if("Enter"===e.key){let t=switchElement.querySelector('input[type="checkbox"]');t.checked=!t.checked,switchElement.classList.toggle("checked")}}),document.querySelectorAll(".iconConnect").forEach(e=>{e.addEventListener("click",()=>{popupBoxConnect.classList.add("show"),document.body.classList.add("noscroll"),titleTagConnect.focus()}),e.addEventListener("keydown",t=>{"Enter"===t.key&&e.click()})}),document.querySelectorAll(".sedeconnecter").forEach(e=>{e.addEventListener("click",()=>{fetchLogout()}),e.addEventListener("keydown",e=>{"Enter"===e.key&&fetchLogout()})}),document.querySelectorAll(".gestionCompte").forEach(e=>{e.addEventListener("click",()=>{popupBoxGestion.classList.add("show"),document.body.classList.add("noscroll"),popupBoxGestion.querySelector("i").focus()}),e.addEventListener("keydown",t=>{"Enter"===t.key&&e.click()})}),document.querySelectorAll(".supprimerCompte").forEach(e=>{e.addEventListener("click",()=>{window.location.pathname.endsWith("en.php")?confirm("Do you really want to delete your account and all your notes saved in the cloud? Your username will become available to other users again.")&&deleteAccount():confirm("Voulez-vous vraiment supprimer votre compte ainsi que toutes vos notes enregistr\xe9es dans le cloud ? Votre nom d'utilisateur redeviendra disponible pour les autres utilisateurs.")&&deleteAccount()}),e.addEventListener("keydown",e=>{"Enter"===e.key&&(window.location.pathname.endsWith("en.php")?confirm("Do you really want to delete your account and all your notes saved in the cloud? Your username will become available to other users again.")&&deleteAccount():confirm("Voulez-vous vraiment supprimer votre compte ainsi que toutes vos notes enregistr\xe9es dans le cloud ? Votre nom d'utilisateur redeviendra disponible pour les autres utilisateurs.")&&deleteAccount())})}),document.querySelectorAll("form").forEach(e=>{e.addEventListener("submit",e=>{e.preventDefault()})}),document.querySelectorAll("header i").forEach(e=>{e.addEventListener("click",()=>{isUpdate=!1,document.querySelectorAll("form").forEach(e=>e.reset()),popupBoxConnect.classList.remove("show"),popupBoxGestion.classList.remove("show"),darken.classList.remove("show"),document.body.classList.remove("noscroll")}),e.addEventListener("keydown",t=>{"Enter"===t.key&&e.click()})}),document.querySelector("#search-input").addEventListener("keyup",()=>{let e=document.querySelector("#search-input").value.trim().toLowerCase();document.querySelectorAll(".note").forEach(t=>{let o=t.querySelector(".note p").innerText.toLowerCase();o.includes(e)?t.style.display="flex":t.style.display="none"})}),document.addEventListener("keydown",e=>{e.ctrlKey&&"k"===e.key&&(e.preventDefault(),document.querySelector("#search-input").focus())}),document.querySelector("#tri").addEventListener("change",async()=>{fetch("/projets/notes/assets/php/sort.php",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:"tri="+document.querySelector("#tri").value}).then(e=>{e.ok&&(document.querySelectorAll(".note").forEach(e=>{e.remove()}),showNotesConnect())})}),couleurs.forEach((e,t)=>{e.addEventListener("click",e=>{couleurs.forEach(e=>{e.classList.remove("selectionne")}),e.target.classList.add("selectionne")}),e.addEventListener("keydown",t=>{"Enter"===t.key&&e.click()}),0===t&&e.classList.add("selectionne")}),document.querySelector("#submitNoteConnect").addEventListener("click",async()=>{let e=document.querySelector("#titleConnect").value.trim(),t=document.querySelector("#descConnect").value;if(!e||!t||t.length>2e3)return;let o=encodeURIComponent(e.replaceAll(/'/g,"‘").replaceAll(/\\/g,"/")),n=encodeURIComponent(t.replaceAll(/'/g,"‘").replaceAll(/\\/g,"/")),s=document.querySelector(".couleurs span.selectionne"),l=s.classList[0],r=new Date().toISOString().slice(0,19).replace("T"," "),a=document.getElementById("checkHidden"),c;c=a.checked?1:0;let i=isUpdate?"/projets/notes/assets/php/updateNote.php":"/projets/notes/assets/php/formAddNote.php",d=isUpdate?`noteId=${document.querySelector("#idNoteInput").value}&title=${o}&filterDesc=${n}&couleur=${l}&date=${r}&hidden=${c}`:`titleConnect=${o}&descriptionConnect=${n}&couleurConnect=${l}&date=${r}&hidden=${c}`;fetch(i,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:d}).then(e=>{200===e.status&&(document.querySelectorAll(".note").forEach(e=>{e.remove()}),isUpdate=!1,popupBoxConnect.classList.remove("show"),document.body.classList.remove("noscroll"),document.querySelectorAll("form").forEach(e=>e.reset()),showNotesConnect())})}),document.querySelector("#submitChangeMDP").addEventListener("click",async()=>{let e=document.querySelector("#mdpModifNew").value,t=document.querySelector("#mdpModifNewValid").value;if(!e||!t){if(window.location.pathname.endsWith("en.php")){alert("One or more fields are empty...");return}alert("Un ou plusieurs champs sont vides...");return}if(e.length<6){if(window.location.pathname.endsWith("en.php")){alert("Password too weak (<6)...");return}alert("Mot de passe trop faible (<6)...");return}if(/^[0-9]+$/.test(e)){if(window.location.pathname.endsWith("en.php")){alert("Password too weak (only numbers)...");return}alert("Mot de passe trop faible (que des chiffres)...");return}if(/^[a-zA-Z]+$/.test(e)){if(window.location.pathname.endsWith("en.php")){alert("Password too weak (only letters)...");return}alert("Mot de passe trop faible (que des lettres)...");return}if(e!==t){if(window.location.pathname.endsWith("en.php")){alert("Passwords do not match...");return}alert("Les mots de passe ne correspondent pas...");return}let o=encodeURIComponent(e);fetch("/projets/notes/assets/php/formChangeMDP.php",{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:"mdpNew="+o}).then(e=>{200===e.status&&(window.location.pathname.endsWith("en.php")?alert("Password changed!"):alert("Mot de passe modifi\xe9 !"),popupBoxGestion.classList.remove("show"),document.body.classList.remove("noscroll"),document.querySelectorAll("form").forEach(e=>e.reset()))})}),document.addEventListener("DOMContentLoaded",()=>{showNotesConnect(),"serviceWorker"in navigator&&navigator.serviceWorker.register("/projets/notes/sw.js")});
